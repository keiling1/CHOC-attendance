<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub è‡ªå‹•åŒæ­¥é»åç³»çµ±</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background-color: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .status-bar { font-size: 13px; padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-loading { background: #fff3cd; color: #856404; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .list-box { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; }
        .tag-present { background: #28a745; }
        .tag-absent { background: #dc3545; }
        .tag-guest { background: #f39c12; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-export { background: #007bff; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“ é»åç³»çµ± (GitHub CSV åŒæ­¥ç‰ˆ)</h2>
    <div id="loadStatus" class="status-bar status-loading">æ­£åœ¨å¾ GitHub è¼‰å…¥åå–® (list.csv)...</div>
    
    <input type="text" id="studentId" placeholder="è¼¸å…¥å­¸è™Ÿå¾ŒæŒ‰ Enter..." autofocus>
</div>

<div class="grid">
    <div class="card">
        <h3>ğŸ“ å·²åˆ°ç´€éŒ„ (<span id="presentCount">0</span>)</h3>
        <div id="checkInList" class="list-box"></div>
    </div>
    <div class="card">
        <h3>ğŸ“‹ æœªåˆ°åå–® (<span id="absentCount">0</span>)</h3>
        <div id="absentList" class="list-box"></div>
    </div>
</div>

<button class="btn-export" onclick="exportResults()">ğŸ“¦ åŒ¯å‡ºé»åå ±è¡¨</button>

<script>
    let masterList = {}; // å„²å­˜å¾ CSV è®€å–çš„åå–®
    let attendance = JSON.parse(localStorage.getItem('gh_attendance')) || [];

    // 1. è‡ªå‹•å¾ GitHub è®€å–åŒç›®éŒ„ä¸‹çš„ list.csv
    async function loadMasterList() {
        const statusDiv = document.getElementById('loadStatus');
        try {
            // ä½¿ç”¨ç›¸å°è·¯å¾‘æŠ“å–åŒä¸€å€‹ Repo è£¡çš„ list.csv
            const response = await fetch('list.csv');
            if (!response.ok) throw new Error('æ‰¾ä¸åˆ° list.csv æª”æ¡ˆ');
            
            const text = await response.text();
            const rows = text.split(/\r?\n/);
            
            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    const id = cols[0].trim().toUpperCase();
                    const name = cols[1].trim();
                    if (id && id !== "å­¸è™Ÿ") masterList[id] = name;
                }
            });

            statusDiv.className = "status-bar status-ok";
            statusDiv.innerText = `âœ… åå–®åŒæ­¥æˆåŠŸï¼å…± ${Object.keys(masterList).length} äºº`;
            updateUI();
        } catch (err) {
            statusDiv.className = "status-bar";
            statusDiv.style.background = "#f8d7da";
            statusDiv.innerText = `âŒ éŒ¯èª¤ï¼š${err.message}ã€‚è«‹ç¢ºèª list.csv å·²ä¸Šå‚³ã€‚`;
        }
    }

    // 2. é»åé‚è¼¯
    function checkIn() {
        const input = document.getElementById('studentId');
        const id = input.value.trim().toUpperCase();
        if (!id) return;

        if (attendance.some(a => a.id === id)) {
            alert("æ­¤å­¸è™Ÿå·²é»éå");
        } else {
            const name = masterList[id] || "åå–®å¤–æˆå“¡";
            const isGuest = !masterList[id];
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            attendance.unshift({ id, name, time, isGuest });
            localStorage.setItem('gh_attendance', JSON.stringify(attendance));
        }
        
        input.value = "";
        updateUI();
    }

    // 3. æ›´æ–°ä»‹é¢
    function updateUI() {
        const checkInBox = document.getElementById('checkInList');
        const absentBox = document.getElementById('absentList');
        
        document.getElementById('presentCount').innerText = attendance.length;
        checkInBox.innerHTML = attendance.map(a => `
            <div class="item">
                <span><b>${a.id}</b> ${a.name} ${a.isGuest ? '<span class="tag tag-guest">åå–®å¤–</span>' : ''}</span>
                <span class="tag tag-present">${a.time}</span>
            </div>
        `).join('');

        const attendedIds = attendance.map(a => a.id);
        const absentees = Object.keys(masterList).filter(id => !attendedIds.includes(id));
        
        document.getElementById('absentCount').innerText = absentees.length;
        absentBox.innerHTML = absentees.map(id => `
            <div class="item" style="color:#999;">
                <span>${id} ${masterList[id]}</span>
                <span class="tag tag-absent">æœªåˆ°</span>
            </div>
        `).join('');
    }

    function exportResults() {
        let csv = "\ufeffå­¸è™Ÿ,å§“å,æ™‚é–“,ç‹€æ…‹\n";
        attendance.forEach(a => csv += `${a.id},${a.name},${a.time},${a.isGuest?'åå–®å¤–':'å·²åˆ°'}\n`);
        Object.keys(masterList).forEach(id => {
            if (!attendance.map(a=>a.id).includes(id)) csv += `${id},${masterList[id]},,æœªåˆ°\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `é»åå ±è¡¨_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    document.getElementById('studentId').addEventListener('keypress', e => { if(e.key==='Enter') checkIn(); });
    
    // å•Ÿå‹•è¼‰å…¥
    loadMasterList();
</script>

</body>
</html>
