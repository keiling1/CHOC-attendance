<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­é»åç³»çµ± - Barcode æƒæèˆ‡è‡ªå‹•åŒ–ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background-color: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .status-bar { font-size: 13px; padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        .status-ok { background: #d4edda; color: #155724; }
        #secretConfig { display: none; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border-left: 5px solid #6c757d; }
        .config-toggle { color: #ccc; cursor: pointer; text-align: right; font-size: 12px; margin-top: -10px; margin-bottom: 10px; }
        input[type="text"], input[type="time"] { padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; width: 100%; }
        .list-box { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; background: #28a745; }
        .tag-absent { background: #dc3545; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-export { background: #007bff; color: white; }
        .btn-clear { background: #6c757d; color: white; font-size: 14px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 10px; display: none; background: #000; }
        .btn-scan { background: #6f42c1; color: white; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="config-toggle" onclick="toggleConfig()">âš™ï¸ å…§éƒ¨è¨­å®š</div>
<div id="secretConfig" class="card">
    <strong>ğŸ¤« å…§éƒ¨è¨­å®š (å­¸ç”Ÿä¸å¯è¦‹)</strong><br><br>
    ğŸ•’ é²åˆ°é–€æª»ï¼š<input type="time" id="lateTime" value="10:30"><br>
    ğŸ•’ å¤§é²åˆ°é–€æª»ï¼š<input type="time" id="veryLateTime" value="11:00"><br>
    ğŸ†” å­¸è™Ÿé•·åº¦ï¼š<input type="number" id="idLength" value="9" style="width:60px;"> (è‡ªå‹•é€å‡ºåˆ¤å®š)
</div>

<div class="card">
    <h2>ğŸ“ èª²ç¨‹é»åç³»çµ±</h2>
    <div id="loadStatus" class="status-bar">è¼‰å…¥ä¸­...</div>
    
    <button class="btn-scan" id="scanBtn" onclick="toggleScanner()">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ Barcode</button>
    <div id="reader"></div>

    <input type="text" id="studentId" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–æƒæçµæœ..." autofocus>
</div>

<div class="grid">
    <div class="card">
        <h3>ğŸ“ å·²åˆ° (<span id="presentCount">0</span>)</h3>
        <div id="checkInList" class="list-box"></div>
    </div>
    <div class="card">
        <h3>ğŸ“‹ æœªåˆ° (<span id="absentCount">0</span>)</h3>
        <div id="absentList" class="list-box"></div>
    </div>
</div>

<button class="btn-export" onclick="exportResults()">ğŸ“¦ åŒ¯å‡ºç•¶é€±å ±è¡¨ (Copy to DB)</button>
<button class="btn-clear" onclick="clearDailyData()">âš ï¸ æ¸…é™¤æœ¬æ¬¡ç´€éŒ„</button>

<script>
    let masterList = {}; 
    let attendance = JSON.parse(localStorage.getItem('gh_attendance')) || [];
    let html5QrCode;

    function toggleConfig() {
        const config = document.getElementById('secretConfig');
        config.style.display = config.style.display === 'block' ? 'none' : 'block';
    }

    // --- Barcode / QR æƒæåŠŸèƒ½ ---
    function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        const btn = document.getElementById('scanBtn');
        
        if (readerDiv.style.display === 'none' || !readerDiv.style.display) {
            readerDiv.style.display = 'block';
            btn.innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
            startScanner();
        } else {
            stopScanner();
            readerDiv.style.display = 'none';
            btn.innerText = "ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ Barcode";
        }
    }

    function startScanner() {
        // è¨­å®šæ”¯æ´æ¢ç¢¼æ ¼å¼
        const formatsToSupport = [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.EAN_13
        ];
        
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 15, qrbox: { width: 300, height: 150 } }; // èª¿æ•´æƒææ¡†æ¯”ä¾‹ä»¥é©æ‡‰æ¢ç¢¼
        
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            document.getElementById('studentId').value = decodedText.trim().toUpperCase();
            checkIn(); // æƒææˆåŠŸè‡ªå‹•åŸ·è¡Œé»åé‚è¼¯
            // æƒææˆåŠŸå¾ŒçŸ­æš«éœ‡å‹•å›é¥‹
            if (navigator.vibrate) navigator.vibrate(100);
        });
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().catch(err => console.error(err));
        }
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    async function loadMasterList() {
        const statusDiv = document.getElementById('loadStatus');
        try {
            const response = await fetch('list.csv?t=' + new Date().getTime());
            if (!response.ok) throw new Error('æ‰¾ä¸åˆ° list.csv');
            const text = await response.text();
            const rows = text.split(/\r?\n/);
            masterList = {};
            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    const id = cols[0].trim().toUpperCase();
                    const name = cols[1].trim();
                    if (id && id !== "å­¸è™Ÿ") masterList[id] = name;
                }
            });
            statusDiv.className = "status-bar status-ok";
            statusDiv.innerText = `âœ… å·²åŒæ­¥ ${Object.keys(masterList).length} äºº`;
            updateUI();
        } catch (err) {
            statusDiv.innerText = `âŒ éŒ¯èª¤: ${err.message}`;
        }
    }

    function checkIn() {
        const input = document.getElementById('studentId');
        const id = input.value.trim().toUpperCase();
        if (!id) return;
        
        if (attendance.some(a => a.id === id)) {
            console.log("å·²é»éå");
        } else {
            const name = masterList[id] || "åå–®å¤–";
            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            attendance.unshift({ id, name, time });
            localStorage.setItem('gh_attendance', JSON.stringify(attendance));
        }
        input.value = "";
        input.style.borderColor = "#ddd";
        updateUI();
    }

    // ç›£è½è¼¸å…¥æ¡†ï¼šé•·åº¦é”åˆ°æ™‚æ™ºæ…§åˆ¤å®š
    document.getElementById('studentId').addEventListener('input', function() {
        const id = this.value.trim().toUpperCase();
        const targetLen = parseInt(document.getElementById('idLength').value);
        
        if (id.length >= targetLen) {
            if (masterList[id]) {
                this.style.borderColor = "#28a745"; // åœ¨åå–®å…§ï¼šè®Šç¶ è‰²
                setTimeout(() => { if(this.value.toUpperCase() === id) checkIn(); }, 400);
            } else {
                this.style.borderColor = "#f39c12"; // åå–®å¤–ï¼šè®Šæ©˜è‰²ï¼Œä¸è‡ªå‹•é€å‡º
            }
        }
    });

    function updateUI() {
        const checkInBox = document.getElementById('checkInList');
        const absentBox = document.getElementById('absentList');
        document.getElementById('presentCount').innerText = attendance.length;
        checkInBox.innerHTML = attendance.map(a => `
            <div class="item">
                <span><b>${a.id}</b> ${a.name}</span>
                <span class="tag">${a.time}</span>
            </div>
        `).join('');
        const attendedIds = attendance.map(a => a.id);
        const absentees = Object.keys(masterList).filter(id => !attendedIds.includes(id));
        document.getElementById('absentCount').innerText = absentees.length;
        absentBox.innerHTML = absentees.map(id => `
            <div class="item" style="color:#999;">
                <span>${id} ${masterList[id]}</span>
                <span class="tag tag-absent">æœªåˆ°</span>
            </div>
        `).join('');
    }

    function exportResults() {
        if (attendance.length === 0 && Object.keys(masterList).length === 0) return;
        const late = document.getElementById('lateTime').value;
        const veryLate = document.getElementById('veryLateTime').value;
        const today = new Date().toLocaleDateString('zh-TW'); 
        let report = [];

        Object.keys(masterList).forEach(id => {
            const record = attendance.find(a => a.id === id);
            if (record) {
                let status = "å·²åˆ°";
                if (record.time > veryLate) status = "å¤§é²åˆ°";
                else if (record.time > late) status = "é²åˆ°";
                report.push({ id, name: masterList[id], date: today, time: record.time, status });
            } else {
                report.push({ id, name: masterList[id], date: today, time: "", status: "æœªåˆ°" });
            }
        });

        const guests = attendance.filter(a => !masterList[a.id]);
        guests.forEach(a => {
            let status = "å·²åˆ°(åå–®å¤–)";
            if (a.time > veryLate) status = "å¤§é²åˆ°(åå–®å¤–)";
            else if (a.time > late) status = "é²åˆ°(åå–®å¤–)";
            report.push({ id: a.id, name: "åå–®å¤–", date: today, time: a.time, status: status });
        });

        report.sort((a, b) => a.id.localeCompare(b.id));
        let csv = "\ufeffå­¸è™Ÿ,å§“å,æ—¥æœŸ,é»åæ™‚é–“,ç‹€æ…‹\n";
        report.forEach(r => csv += `${r.id},${r.name},${r.date},${r.time},${r.status}\n`);

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Attendance_${today.replace(/\//g,'-')}.csv`;
        a.click();
    }

    function clearDailyData() {
        if (confirm("ç¢ºå®šæ¸…é™¤ç´€éŒ„ï¼Ÿ")) {
            attendance = [];
            localStorage.removeItem('gh_attendance');
            updateUI();
        }
    }
    
    document.getElementById('studentId').addEventListener('keypress', e => { if(e.key==='Enter') checkIn(); });
    loadMasterList();
</script>
</body>
</html>
