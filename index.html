<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­é»åç³»çµ±</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background-color: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .status-bar { font-size: 13px; padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        .status-ok { background: #d4edda; color: #155724; }
        /* éš±è—è¨­å®šå€æ¨£å¼ */
        #secretConfig { display: none; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border-left: 5px solid #6c757d; }
        .config-toggle { color: #ccc; cursor: pointer; text-align: right; font-size: 12px; margin-top: -10px; margin-bottom: 10px; }
        input[type="text"], input[type="time"] { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .list-box { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; background: #28a745; }
        .tag-absent { background: #dc3545; }
        .tag-guest { background: #f39c12; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-export { background: #007bff; color: white; margin-top: 20px; }
        .btn-clear { background: #6c757d; color: white; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="config-toggle" onclick="toggleConfig()">âš™ï¸ è¨­å®š</div>
<div id="secretConfig" class="card">
    <strong>ğŸ¤« å…§éƒ¨åˆ¤å®šæ™‚é–“è¨­å®š (å­¸ç”Ÿçœ‹ä¸è¦‹)</strong><br><br>
    ğŸ•’ é²åˆ°é–€æª»ï¼š<input type="time" id="lateTime" value="14:10"><br>
    ğŸ•’ å¤§é²åˆ°é–€æª»ï¼š<input type="time" id="veryLateTime" value="14:30">
</div>

<div class="card">
    <h2>ğŸ“ å­¸ç”Ÿé»åç³»çµ±</h2>
    <div id="loadStatus" class="status-bar status-loading">æ­£åœ¨å¾ GitHub è¼‰å…¥åå–® (list.csv)...</div>
    <input type="text" id="studentId" placeholder="è¼¸å…¥å­¸è™Ÿå¾ŒæŒ‰ Enter..." autofocus style="width:100%;">
</div>

<div class="grid">
    <div class="card">
        <h3>ğŸ“ å·²åˆ°ç´€éŒ„ (<span id="presentCount">0</span>)</h3>
        <div id="checkInList" class="list-box"></div>
    </div>
    <div class="card">
        <h3>ğŸ“‹ æœªåˆ°åå–® (<span id="absentCount">0</span>)</h3>
        <div id="absentList" class="list-box"></div>
    </div>
</div>

<div style="padding-bottom: 50px;">
    <button class="btn-export" onclick="exportResults()">ğŸ“¦ åŒ¯å‡ºé»åå ±è¡¨ (CSV)</button>
    <button class="btn-clear" onclick="clearDailyData()">âš ï¸ æ¸…é™¤æœ¬æ¬¡é»åç´€éŒ„</button>
</div>

<script>
    let masterList = {}; 
    let attendance = JSON.parse(localStorage.getItem('gh_attendance')) || [];

    // éš±è—è¨­å®šé–‹é—œ
    function toggleConfig() {
        const config = document.getElementById('secretConfig');
        config.style.display = config.style.display === 'block' ? 'none' : 'block';
    }

    async function loadMasterList() {
        const statusDiv = document.getElementById('loadStatus');
        try {
            const response = await fetch('list.csv?t=' + new Date().getTime());
            if (!response.ok) throw new Error('æ‰¾ä¸åˆ° list.csv æª”æ¡ˆ');
            const text = await response.text();
            const rows = text.split(/\r?\n/);
            masterList = {};
            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    const id = cols[0].trim().toUpperCase();
                    const name = cols[1].trim();
                    if (id && id !== "å­¸è™Ÿ") masterList[id] = name;
                }
            });
            statusDiv.className = "status-bar status-ok";
            statusDiv.innerText = `âœ… åå–®åŒæ­¥æˆåŠŸï¼å…± ${Object.keys(masterList).length} äºº`;
            updateUI();
        } catch (err) {
            statusDiv.innerText = `âŒ éŒ¯èª¤ï¼š${err.message}`;
        }
    }

    function checkIn() {
        const input = document.getElementById('studentId');
        const id = input.value.trim().toUpperCase();
        if (!id) return;

        if (attendance.some(a => a.id === id)) {
            alert("æ­¤å­¸è™Ÿå·²é»éå");
        } else {
            const name = masterList[id] || "åå–®å¤–æˆå“¡";
            const isGuest = !masterList[id];
            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            attendance.unshift({ id, name, time, isGuest });
            localStorage.setItem('gh_attendance', JSON.stringify(attendance));
        }
        input.value = "";
        updateUI();
    }

    function updateUI() {
        const checkInBox = document.getElementById('checkInList');
        const absentBox = document.getElementById('absentList');
        document.getElementById('presentCount').innerText = attendance.length;

        checkInBox.innerHTML = attendance.map(a => `
            <div class="item">
                <span><b>${a.id}</b> ${a.name} ${a.isGuest ? '<span class="tag tag-guest">åå–®å¤–</span>' : ''}</span>
                <span class="tag">${a.time}</span>
            </div>
        `).join('');

        const attendedIds = attendance.map(a => a.id);
        const absentees = Object.keys(masterList).filter(id => !attendedIds.includes(id));
        document.getElementById('absentCount').innerText = absentees.length;
        absentBox.innerHTML = absentees.map(id => `
            <div class="item" style="color:#999;">
                <span>${id} ${masterList[id]}</span>
                <span class="tag tag-absent">æœªåˆ°</span>
            </div>
        `).join('');
    }

    function exportResults() {
        if (attendance.length === 0 && Object.keys(masterList).length === 0) return;

        const late = document.getElementById('lateTime').value;
        const veryLate = document.getElementById('veryLateTime').value;
        
        let report = [];
        // è™•ç†åå–®å…§æ‰€æœ‰äºº
        Object.keys(masterList).forEach(id => {
            const record = attendance.find(a => a.id === id);
            if (record) {
                let status = "å·²åˆ°";
                if (record.time > veryLate) status = "å¤§é²åˆ°";
                else if (record.time > late) status = "é²åˆ°";
                report.push({ id, name: masterList[id], time: record.time, status });
            } else {
                report.push({ id, name: masterList[id], time: "", status: "æœªåˆ°" });
            }
        });

        // è™•ç†åå–®å¤–äººå“¡
        attendance.filter(a => !masterList[a.id]).forEach(a => {
            report.push({ id: a.id, name: "åå–®å¤–", time: a.time, status: "åå–®å¤–ç™»è¨˜" });
        });

        // ä¾å­¸è™Ÿæ’åºæ–¹ä¾¿ XLOOKUP
        report.sort((a, b) => a.id.localeCompare(b.id));

        let csv = "\ufeffå­¸è™Ÿ,å§“å,æ™‚é–“,ç‹€æ…‹\n";
        report.forEach(r => csv += `${r.id},${r.name},${r.time},${r.status}\n`);

        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `é»åå®Œæ•´å ±è¡¨_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    function clearDailyData() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºã€ä»Šå¤©çš„é»åç´€éŒ„ã€å—ï¼Ÿ")) {
            attendance = [];
            localStorage.removeItem('gh_attendance');
            updateUI();
        }
    }

    document.getElementById('studentId').addEventListener('keypress', e => { if(e.key==='Enter') checkIn(); });
    loadMasterList();
</script>

</body>
</html>
