<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­é»åç³»çµ± - æœ€çµ‚æ•´åˆç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background-color: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .status-bar { font-size: 13px; padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        .status-ok { background: #d4edda; color: #155724; }
        #secretConfig { display: none; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .config-toggle { color: #ccc; cursor: pointer; text-align: right; font-size: 12px; }
        input[type="text"], input[type="time"] { padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .list-box { height: 350px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; background: #28a745; }
        .btn-export { background: #007bff; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; margin-top: 10px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; display: none; margin-top: 10px; }
        #zoomContainer { display:none; margin: 10px 0; background: #eee; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="config-toggle" onclick="toggleConfig()">âš™ï¸ å…§éƒ¨è¨­å®š</div>
<div id="secretConfig" class="card">
    <strong>ğŸ¤« åˆ¤å®šæ™‚é–“èˆ‡è‡ªå‹•åŒ–è¨­å®š</strong><br><br>
    ğŸ•’ é²åˆ°ï¼š<input type="time" id="lateTime" value="10:30">
    ğŸ•’ å¤§é²åˆ°ï¼š<input type="time" id="veryLateTime" value="11:00"><br>
    ğŸ†” å­¸è™Ÿé•·åº¦ï¼š<input type="number" id="idLength" value="9" style="width:60px;">
</div>

<div class="card">
    <h2>ğŸ“ èª²ç¨‹é»åç³»çµ±</h2>
    <div id="loadStatus" class="status-bar">è¼‰å…¥ä¸­...</div>
    <button onclick="toggleScanner()" style="background:#6f42c1; color:white; padding:10px; width:100%; border:none; border-radius:6px; font-weight:bold;">ğŸ“· é–‹å•Ÿæ¢ç¢¼æƒæ</button>
    <div id="zoomContainer">
        <label>ğŸ” ç¸®æ”¾ (å°ä¸åˆ°ç„¦è«‹æ‹¿é ä¸¦æ”¾å¤§):</label>
        <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1" style="width:100%;">
    </div>
    <div id="reader"></div>
    <input type="text" id="studentId" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–æƒæçµæœ..." autofocus style="margin-top:10px;">
</div>

<div class="grid">
    <div class="card"><h3>ğŸ“ å·²åˆ° (<span id="presentCount">0</span>)</h3><div id="checkInList" class="list-box"></div></div>
    <div class="card"><h3>ğŸ“‹ æœªåˆ° (<span id="absentCount">0</span>)</h3><div id="absentList" class="list-box"></div></div>
</div>

<button class="btn-export" onclick="exportResults()">ğŸ“¦ åŒ¯å‡ºç•¶é€±å ±è¡¨ (æ‰‹å‹•è²¼è‡³ Excel)</button>

<script>
    let masterList = {}; 
    let attendance = JSON.parse(localStorage.getItem('gh_attendance')) || [];
    let html5QrCode;
    let videoTrack = null;

    function toggleConfig() { const s = document.getElementById('secretConfig'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }

    function toggleScanner() {
        const r = document.getElementById('reader');
        if (r.style.display === 'none' || !r.style.display) { r.style.display = 'block'; startScanner(); }
        else { stopScanner(); r.style.display = 'none'; }
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 20, qrbox: { width: 300, height: 120 } };
        html5QrCode.start({ facingMode: "environment" }, config, (text) => {
            document.getElementById('studentId').value = text.trim().toUpperCase();
            checkIn();
        }).then(() => {
            videoTrack = html5QrCode.getRunningTrack();
            const cap = videoTrack.getCapabilities();
            if (cap.zoom) {
                document.getElementById('zoomContainer').style.display = 'block';
                const z = document.getElementById('zoomRange');
                z.min = cap.zoom.min; z.max = cap.zoom.max; z.oninput = () => { videoTrack.applyConstraints({advanced: [{zoom: z.value}]}); };
            }
        });
    }

    function stopScanner() { if (html5QrCode) html5QrCode.stop(); }

    async function loadMasterList() {
        try {
            const resp = await fetch('list.csv?t=' + new Date().getTime());
            const text = await resp.text();
            text.split(/\r?\n/).forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    const id = cols[0].trim().toUpperCase();
                    if (id && id !== "å­¸è™Ÿ") masterList[id] = cols[1].trim();
                }
            });
            document.getElementById('loadStatus').innerText = `âœ… å·²åŒæ­¥ ${Object.keys(masterList).length} äºº`;
            updateUI();
        } catch (e) { document.getElementById('loadStatus').innerText = "âŒ è¼‰å…¥å¤±æ•—"; }
    }

    function checkIn() {
        const input = document.getElementById('studentId');
        const id = input.value.trim().toUpperCase();
        if (!id || attendance.some(a => a.id === id)) { input.value = ""; return; }
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        attendance.unshift({ id, name: masterList[id] || "åå–®å¤–", time });
        localStorage.setItem('gh_attendance', JSON.stringify(attendance));
        input.value = ""; updateUI();
    }

    document.getElementById('studentId').addEventListener('input', function() {
        const id = this.value.trim().toUpperCase();
        if (id.length >= document.getElementById('idLength').value && masterList[id]) {
            this.style.borderColor = "#28a745";
            setTimeout(() => { if(this.value.toUpperCase() === id) checkIn(); }, 400);
        }
    });

    function updateUI() {
        document.getElementById('presentCount').innerText = attendance.length;
        document.getElementById('checkInList').innerHTML = attendance.map(a => `<div class="item"><span><b>${a.id}</b> ${a.name}</span><span class="tag">${a.time}</span></div>`).join('');
        const attendedIds = attendance.map(a => a.id);
        const absentees = Object.keys(masterList).filter(id => !attendedIds.includes(id));
        document.getElementById('absentCount').innerText = absentees.length;
        document.getElementById('absentList').innerHTML = absentees.map(id => `<div class="item" style="color:#999;"><span>${id} ${masterList[id]}</span></div>`).join('');
    }

    function exportResults() {
        const late = document.getElementById('lateTime').value;
        const veryLate = document.getElementById('veryLateTime').value;
        const today = new Date().toLocaleDateString('zh-TW');
        let csv = "\ufeffå­¸è™Ÿ,å§“å,æ—¥æœŸ,æ™‚é–“,ç‹€æ…‹\n";
        
        Object.keys(masterList).forEach(id => {
            const rec = attendance.find(a => a.id === id);
            let status = "æœªåˆ°";
            if (rec) {
                status = rec.time > veryLate ? "å¤§é²åˆ°" : (rec.time > late ? "é²åˆ°" : "å·²åˆ°");
            }
            csv += `${id},${masterList[id]},${today},${rec ? rec.time : ""},${status}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Attendance_${today.replace(/\//g,'-')}.csv`;
        a.click();
    }

    loadMasterList();
    document.getElementById('studentId').addEventListener('keypress', e => { if(e.key==='Enter') checkIn(); });
</script>
</body>
</html>
