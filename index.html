<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­é»åç³»çµ± - æ”¯æ´åå–®å¤–ç™»è¨˜</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f8f9fa; color: #333; }
        .container { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        h2, h3 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex-grow: 1; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; font-size: 12px; }
        .list-box { height: 450px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 12px; padding: 3px 8px; border-radius: 4px; font-weight: normal; }
        .tag-member { background: #d4edda; color: #155724; } /* åå–®å…§ */
        .tag-guest { background: #fff3cd; color: #856404; }  /* åå–®å¤– */
        .tag-absent { background: #f8d7da; color: #721c24; } /* ç¼ºå¸­ */
        .config-section { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="card full-width">
    <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
    <div class="config-section">
        <div>
            <label style="display:block; margin-bottom:5px;">åŒ¯å…¥å›ºå®šåå–® (CSV: å­¸è™Ÿ,å§“å)</label>
            <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(this)">
        </div>
        <button class="btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„èˆ‡åå–®</button>
    </div>

    <div class="container">
        <div>
            <h3>ğŸ“ ç¾å ´é»å</h3>
            <div class="input-group">
                <input type="text" id="studentId" placeholder="è¼¸å…¥å­¸è™Ÿå¾ŒæŒ‰ Enter..." autofocus>
                <button class="btn-primary" onclick="checkIn()">ç¢ºèªé»å</button>
            </div>
            <div id="checkInList" class="list-box"></div>
            <button class="btn-primary" style="width:100%; margin-top:15px; font-size:18px;" onclick="exportResults()">ğŸ“¦ åŒ¯å‡ºå®Œæ•´å ±è¡¨ (Excel)</button>
        </div>

        <div>
            <h3>ğŸ“‹ æ‡‰åˆ°æœªåˆ° (<span id="absentCount">0</span>)</h3>
            <div id="absentList" class="list-box"></div>
        </div>
    </div>
</div>

<script>
    let masterList = JSON.parse(localStorage.getItem('master_list')) || {}; 
    let attendance = JSON.parse(localStorage.getItem('attendance_log')) || []; 

    window.onload = updateUI;

    function handleFileUpload(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split(/\r?\n/);
            let newList = {};
            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    const id = cols[0].trim().toUpperCase();
                    const name = cols[1].trim();
                    if (id && id !== "å­¸è™Ÿ") newList[id] = name;
                }
            });
            masterList = newList;
            localStorage.setItem('master_list', JSON.stringify(masterList));
            alert(`åå–®åŒ¯å…¥æˆåŠŸï¼å…± ${Object.keys(masterList).length} äºº`);
            updateUI();
        };
        reader.readAsText(file);
    }

    function checkIn() {
        const input = document.getElementById('studentId');
        const id = input.value.trim().toUpperCase();
        if (!id) return;

        if (attendance.some(a => a.id === id)) {
            alert("æ­¤å­¸è™Ÿå·²é»éåï¼");
            input.value = "";
            return;
        }

        const isMember = !!masterList[id];
        const name = isMember ? masterList[id] : "åå–®å¤–æˆå“¡";
        const type = isMember ? "MEMBER" : "GUEST";
        
        recordAttendance(id, name, type);
        input.value = "";
        input.focus();
    }

    function recordAttendance(id, name, type) {
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        attendance.unshift({ id, name, time, type });
        localStorage.setItem('attendance_log', JSON.stringify(attendance));
        updateUI();
    }

    function updateUI() {
        const checkInBox = document.getElementById('checkInList');
        const absentBox = document.getElementById('absentList');
        const absentCount = document.getElementById('absentCount');

        // å·²åˆ°æ¸…å–® (åŒ…å«åå–®å¤–)
        checkInBox.innerHTML = attendance.map(a => `
            <div class="item">
                <span>
                    <b>${a.id}</b> ${a.name}
                    ${a.type === 'GUEST' ? '<span class="tag tag-guest">åå–®å¤–ç™»è¨˜</span>' : ''}
                </span>
                <span class="tag tag-member">${a.time}</span>
            </div>
        `).join('');

        // ç¼ºå¸­åå–® (åƒ…è¨ˆç®— masterList è£¡é¢çš„äºº)
        const attendedIds = attendance.map(a => a.id);
        const absentees = Object.keys(masterList).filter(id => !attendedIds.includes(id));
        
        absentCount.innerText = absentees.length;
        absentBox.innerHTML = absentees.map(id => `
            <div class="item">
                <span style="color:#999;">${id} ${masterList[id]}</span>
                <span class="tag tag-absent">æœªåˆ°</span>
            </div>
        `).join('');
    }

    function exportResults() {
        if (attendance.length === 0 && Object.keys(masterList).length === 0) return alert("ç›®å‰ç„¡è³‡æ–™");

        let csv = "\ufeffå­¸è™Ÿ,å§“å,é»åæ™‚é–“,èº«åˆ†ç‹€æ…‹\n";
        
        // 1. å…ˆåˆ—å‡ºå·²é»åçš„äºº (å«åå–®å¤–)
        attendance.forEach(a => {
            const status = a.type === 'GUEST' ? "ç¾å ´ç™»è¨˜(éåå–®å…§)" : "å·²åˆ°";
            csv += `${a.id},${a.name},${a.time},${status}\n`;
        });

        // 2. å†åˆ—å‡ºåå–®å…§ä½†æœªåˆ°çš„äºº
        const attendedIds = attendance.map(a => a.id);
        Object.keys(masterList).forEach(id => {
            if (!attendedIds.includes(id)) {
                csv += `${id},${masterList[id]},,æœªåˆ°\n`;
            }
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `é»åå ±è¡¨_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    function clearAllData() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    document.getElementById('studentId').addEventListener('keypress', e => { if(e.key==='Enter') checkIn(); });
</script>

</body>
</html>
